<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>33. DNSSEC - Computer Security</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>DNSSEC | Computer Security</title> <meta name="generator" content="Jekyll v3.9.2" /> <meta property="og:title" content="DNSSEC" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Online textbook for CS 161: Computer Security at UC Berkeley." /> <meta property="og:description" content="Online textbook for CS 161: Computer Security at UC Berkeley." /> <link rel="canonical" href="/network/dnssec.html" /> <meta property="og:url" content="/network/dnssec.html" /> <meta property="og:site_name" content="Computer Security" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="DNSSEC" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Online textbook for CS 161: Computer Security at UC Berkeley.","headline":"DNSSEC","url":"/network/dnssec.html"}</script> <!-- End Jekyll SEO tag --> <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML" ></script> <script> let toggleDark = () => { let setDark = jtd.getTheme() !== 'dark'; jtd.setTheme(setDark ? 'dark' : 'default'); localStorage.setItem('darkMode', String(setDark)); }; window.addEventListener('DOMContentLoaded', () => { /* Add event to dark mode button. */ let a = document.getElementsByClassName('site-button')[2]; a.addEventListener('click', (e) => { e.preventDefault(); toggleDark(); }); /* Read local storage state. */ if (localStorage.getItem('darkMode') === 'true') { toggleDark(); } }); </script> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Computer Security </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Introduction</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Security Principles category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/principles/" class="nav-list-link">Security Principles</a><ul class="nav-list "><li class="nav-list-item "><a href="/principles/principles.html" class="nav-list-link">1. Security Principles</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Memory Safety category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/memory-safety/" class="nav-list-link">Memory Safety</a><ul class="nav-list "><li class="nav-list-item "><a href="/memory-safety/x86.html" class="nav-list-link">2. x86 Assembly and Call Stack</a></li><li class="nav-list-item "><a href="/memory-safety/vulnerabilities.html" class="nav-list-link">3. Memory Safety Vulnerabilities</a></li><li class="nav-list-item "><a href="/memory-safety/mitigations.html" class="nav-list-link">4. Mitigating Memory-Safety Vulnerabilities</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Cryptography category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/crypto/" class="nav-list-link">Cryptography</a><ul class="nav-list "><li class="nav-list-item "><a href="/crypto/intro.html" class="nav-list-link">5. Introduction to Cryptography</a></li><li class="nav-list-item "><a href="/crypto/symmetric.html" class="nav-list-link">6. Symmetric-Key Cryptography</a></li><li class="nav-list-item "><a href="/crypto/hashes.html" class="nav-list-link">7. Cryptographic Hashes</a></li><li class="nav-list-item "><a href="/crypto/macs.html" class="nav-list-link">8. Message Authentication Codes (MACs)</a></li><li class="nav-list-item "><a href="/crypto/prng.html" class="nav-list-link">9. Pseudorandom Number Generators</a></li><li class="nav-list-item "><a href="/crypto/key-exchange.html" class="nav-list-link">10. Diffie-Hellman Key Exchange</a></li><li class="nav-list-item "><a href="/crypto/public-key.html" class="nav-list-link">11. Public-Key Encryption</a></li><li class="nav-list-item "><a href="/crypto/signatures.html" class="nav-list-link">12. Digital Signatures</a></li><li class="nav-list-item "><a href="/crypto/certificates.html" class="nav-list-link">13. Certificates</a></li><li class="nav-list-item "><a href="/crypto/passwords.html" class="nav-list-link">14. Passwords</a></li><li class="nav-list-item "><a href="/crypto/case-studies.html" class="nav-list-link">15. Case Studies</a></li><li class="nav-list-item "><a href="/crypto/bitcoin.html" class="nav-list-link">16. Bitcoin</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Web Security category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/web/" class="nav-list-link">Web Security</a><ul class="nav-list "><li class="nav-list-item "><a href="/web/sqli.html" class="nav-list-link">17. SQL Injection</a></li><li class="nav-list-item "><a href="/web/intro.html" class="nav-list-link">18. Introduction to the Web</a></li><li class="nav-list-item "><a href="/web/sop.html" class="nav-list-link">19. Same-Origin Policy</a></li><li class="nav-list-item "><a href="/web/cookies.html" class="nav-list-link">20. Cookies and Session Management</a></li><li class="nav-list-item "><a href="/web/csrf.html" class="nav-list-link">21. Cross-Site Request Forgery (CSRF)</a></li><li class="nav-list-item "><a href="/web/xss.html" class="nav-list-link">22. Cross-Site Scripting (XSS)</a></li><li class="nav-list-item "><a href="/web/ui-attacks.html" class="nav-list-link">23. UI Attacks</a></li><li class="nav-list-item "><a href="/web/captchas.html" class="nav-list-link">24. CAPTCHAs</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Network Security category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/network/" class="nav-list-link">Network Security</a><ul class="nav-list "><li class="nav-list-item "><a href="/network/intro.html" class="nav-list-link">25. Introduction to Networking</a></li><li class="nav-list-item "><a href="/network/arp.html" class="nav-list-link">26. ARP</a></li><li class="nav-list-item "><a href="/network/wpa.html" class="nav-list-link">27. WPA</a></li><li class="nav-list-item "><a href="/network/dhcp.html" class="nav-list-link">28. DHCP</a></li><li class="nav-list-item "><a href="/network/bgp.html" class="nav-list-link">29. BGP</a></li><li class="nav-list-item "><a href="/network/transport.html" class="nav-list-link">30. TCP and UDP</a></li><li class="nav-list-item "><a href="/network/tls.html" class="nav-list-link">31. TLS</a></li><li class="nav-list-item "><a href="/network/dns.html" class="nav-list-link">32. DNS</a></li><li class="nav-list-item active"><a href="/network/dnssec.html" class="nav-list-link active">33. DNSSEC</a></li><li class="nav-list-item "><a href="/network/dos.html" class="nav-list-link">34. Denial-of-Service (DoS)</a></li><li class="nav-list-item "><a href="/network/firewalls.html" class="nav-list-link">35. Firewalls</a></li><li class="nav-list-item "><a href="/network/intrusion-detection.html" class="nav-list-link">36. Intrusion Detection</a></li><li class="nav-list-item "><a href="/network/abusing-intrusion-detection.html" class="nav-list-link">37. Abusing Intrusion Detection</a></li><li class="nav-list-item "><a href="/network/malware.html" class="nav-list-link">38. Malware</a></li><li class="nav-list-item "><a href="/network/tor.html" class="nav-list-link">39. Anonymity and Tor</a></li></ul></li><li class="nav-list-item"><a href="/glossary.html" class="nav-list-link">Glossary</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Computer Security" aria-label="Search Computer Security" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://cs161.org" class="site-button" > CS 161 </a> </li> <li class="aux-nav-list-item"> <a href="#" class="site-button" > Dark Mode </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/network/">Network Security</a></li> <li class="breadcrumb-nav-list-item"><span>33. DNSSEC</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="33-dnssec"> <a href="#33-dnssec" class="anchor-heading" aria-labelledby="33-dnssec"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 33. DNSSEC </h1> <p><strong>DNSSEC</strong> is an extension to regular DNS that provides integrity and authentication on all DNS messages sent. Sanity check: Why do we not care about the confidentiality of DNSSEC?<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup></p> <h2 id="331-signing-records"> <a href="#331-signing-records" class="anchor-heading" aria-labelledby="331-signing-records"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 33.1. Signing records </h2> <p>We want every DNS record to have integrity and authenticity, and we want everyone to be able to verify the integrity and authenticity of records. Digital signatures are a good fit in this situation, because only someone with the private key can create signatures, and everyone can use the public key to verify signatures.</p> <p>To ensure integrity and authenticity, let’s have every name server generate a public/private key pair and sign every record it sends with its private key. When the name server receives a DNS request, it sends the records, along with a signature on the records and the public key, to the resolver. The resolver uses the public key to verify the signature on the records.</p> <p>Because of the signatures, a network attacker (MITM, on-path, off-path) cannot tamper with the data or inject malicious data without being detected (integrity). Also, the resolver can cache the signatures and the public key, and check at any time that the records actually came from the name server (authenticity).</p> <p>You might see a flaw in this design: what if a name server is malicious? Then the malicious name server could return valid signatures on malicious records. How do we modify our design to prevent this?</p> <h2 id="332-delegating-trust"> <a href="#332-delegating-trust" class="anchor-heading" aria-labelledby="332-delegating-trust"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 33.2. Delegating trust </h2> <p>The main issue in our design so far is we lack a <em>trust anchor</em>. We want DNSSEC to defend against malicious name servers, so we cannot implicitly trust the name servers. However, if we don’t trust anybody, then DNSSEC will never work (we’ll never trust any records we get), so we must first choose a trust anchor, an entity that we implicitly trust. In DNSSEC, the root servers are the trust anchor: every computer automatically assumes that the root server is honest and uncompromised. In real life, this is a safe assumption, because the organizations overseeing the Internet hold painstakingly formal ceremonies to ensure that the root server is uncompromised. (If you’re interested, you can <a href="https://www.cloudflare.com/dns/dnssec/root-signing-ceremony/">read more about the root signing ceremony here</a>.)</p> <p>Given a trust anchor, we can now <em>delegate trust</em> from the trust anchor to somebody else. If the root endorses Alice, then you can be sure that Alice is trusted as well, since you implicitly trust the root. Also, if Alice endorses Bob, then you can be sure that Bob is trusted, since you trust Alice. This trust delegation starting from the root is how DNSSEC delegates trust from the root to all legitimate name servers, while protecting against malicious name servers.</p> <p>Consider two parties, root and Alice, who each have a public key and a private key. You trust root, because it is the trust anchor. The root can delegate trust to Alice by <em>signing Alice’s public key</em>. The root’s signature on Alice’s public key effectively says that Alice’s public key is trustworthy, and the root trusts any message signed by Alice using her corresponding private key.</p> <p>Now, when Alice signs a message, we can use Alice’s public key to verify that the message was properly signed by Alice. Also, we know that Alice’s public key is trusted, because the root has signed it, and we implicitly trust the root.</p> <p>If Alice was malicious, then the root would not delegate trust to her by signing her public key, because we are trusting that the root is honest and uncompromised.</p> <p>We can apply this delegation idea to the entire DNS tree. Each name server will sign the public key of all its trusted children name servers. For example, root signs <code class="language-plaintext highlighter-rouge">.edu</code>’s public key. We trust root, and root signed <code class="language-plaintext highlighter-rouge">.edu</code>’s public key, so now we trust <code class="language-plaintext highlighter-rouge">.edu</code>. Next, <code class="language-plaintext highlighter-rouge">.edu</code> signs <code class="language-plaintext highlighter-rouge">berkeley.edu</code>’s public key. We trust <code class="language-plaintext highlighter-rouge">.edu</code>, and <code class="language-plaintext highlighter-rouge">.edu</code> signed <code class="language-plaintext highlighter-rouge">berkeley.edu</code>’s public key, so now we trust <code class="language-plaintext highlighter-rouge">berkeley.edu</code>.</p> <h2 id="333-dnssec-intuition"> <a href="#333-dnssec-intuition" class="anchor-heading" aria-labelledby="333-dnssec-intuition"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 33.3. DNSSEC Intuition </h2> <p>With these ideas in mind, let’s revisit the DNS query for <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code> from earlier and convert it to a secure DNSSEC query. <em>The DNSSEC additions are italicized.</em></p> <p><img src="/assets/images/network/dns/dnsquery.png" alt="Diagram of a recursive DNS query, where your resolver queries the root nameserver first in query 1 and response 2, then the nameserver at the second level of the tree in query 3 and response 4, then a nameserver at the third level of the tree in query 5 and response 6" /></p> <ol> <li> <p>You to the root name server: Please tell me the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>.</p> </li> <li> <p>Root server to you: I don’t know, but I can redirect you to another name server with more information. This name server is responsible for the <code class="language-plaintext highlighter-rouge">.edu</code> zone. It has human-readable domain name <code class="language-plaintext highlighter-rouge">a.edu-servers.net</code> and IP address <code class="language-plaintext highlighter-rouge">192.5.6.30</code>. <em>Here is a signature on the next name server’s public key. If you trust me, then now you trust them too. Finally, here is my public key.</em></p> </li> <li> <p>You to the <code class="language-plaintext highlighter-rouge">.edu</code> name server: Please tell me the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>.</p> </li> <li> <p>The <code class="language-plaintext highlighter-rouge">.edu</code> name server to you: I don’t know, but I can redirect you to another name server with more information. This name server is responsible for the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> zone. It has human-readable domain name <code class="language-plaintext highlighter-rouge">adns1.berkeley.edu</code> and IP address <code class="language-plaintext highlighter-rouge">128.32.136.3</code>. <em>Here is a signature on the next name server’s public key. If you trust me, then now you trust them too. Finally, here is my public key.</em></p> </li> <li> <p>You to the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server: Please tell me the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>.</p> </li> <li> <p>The <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server to you: OK, the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code> is <code class="language-plaintext highlighter-rouge">23.185.0.1</code>. <em>Finally, here is my public key and a signature on the answer.</em></p> </li> </ol> <p>Note that we implicitly trust all signed messages from the root, because the root is our trust anchor. In practice, all DNS resolvers have the root’s public key hardcoded, and any messages verified with that hardcoded key are implicitly trusted.</p> <p>Congratulations, you now have all the intuition for how DNSSEC works! The rest of this section shows how we implement this design in DNS.</p> <h2 id="334-new-dnssec-record-types"> <a href="#334-new-dnssec-record-types" class="anchor-heading" aria-labelledby="334-new-dnssec-record-types"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 33.4. New DNSSEC record types </h2> <p>To store cryptographic information in DNS messages, we need to introduce a few new record types.</p> <p>The <strong><code class="language-plaintext highlighter-rouge">DNSKEY</code> type record</strong> encodes a public key.</p> <p>The <strong><code class="language-plaintext highlighter-rouge">RRSIG</code> type record</strong> is a signature on a set of multiple other records in the message, all of the same type. For example, if the authority section returns 13 <code class="language-plaintext highlighter-rouge">NS</code> type records, you can sign all 13 records at once with one <code class="language-plaintext highlighter-rouge">RRSIG</code> type record. However, to sign the 26 <code class="language-plaintext highlighter-rouge">A</code> type records in the additional section, you would need another <code class="language-plaintext highlighter-rouge">RRSIG</code> type record. In addition to the actual cryptographic signature, the <code class="language-plaintext highlighter-rouge">RRSIG</code> type record contains the type of the records being signed, the signature creation and expiration date, and the identity of the signer (information about which public key/<code class="language-plaintext highlighter-rouge">DNSKEY</code> record should be used to verify this signature).</p> <p>The <strong><code class="language-plaintext highlighter-rouge">DS</code> (Delegated Signer) type record</strong> is a hash of the signer’s name and a child’s public key. The <code class="language-plaintext highlighter-rouge">DS</code> record, combined with a <code class="language-plaintext highlighter-rouge">RRSIG</code> record that signs the <code class="language-plaintext highlighter-rouge">DS</code> record, effectively allows each name server to sign the public key of its trusted children.</p> <p>All DNSSEC cryptographic records additionally include some (uninteresting) metadata, such as which algorithm was used for signing/verifying/hashing.</p> <p>You might have noticed that the number of additional records is always 1 more than the actual number of additional records that appear in the response. For example, consider the final query in our regular DNS query walkthrough:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dig +norecurse eecs.berkeley.edu @128.32.136.3

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 52788
;; flags: qr aa; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; QUESTION SECTION:
;eecs.berkeley.edu.         IN   A

;; ANSWER SECTION:
eecs.berkeley.edu.  86400   IN   A   23.185.0.1
</code></pre></div></div> <p>The response reports 1 additional record but shows no additional records at all. This extra record corresponds to the <code class="language-plaintext highlighter-rouge">OPT</code> pseudosection (seen just above the question section). This pseudosection allows extra space for DNSSEC-specific flags (e.g. the <code class="language-plaintext highlighter-rouge">DO</code> flag requests DNSSEC information), but in order to be backwards-compatible with regular DNS, the section is encoded as an additional record when sent in the request and the reply.</p> <h2 id="335-key-signing-keys-and-zone-signing-keys"> <a href="#335-key-signing-keys-and-zone-signing-keys" class="anchor-heading" aria-labelledby="335-key-signing-keys-and-zone-signing-keys"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 33.5. Key Signing Keys and Zone Signing Keys </h2> <p>There is one final complication in DNSSEC–what if a name server wants to change its key pair? A key change is necessary if, for example, an attacker steals the private key of a trusted name server, because now the attacker can impersonate a trusted name server.</p> <p>In our current DNSSEC design, a name server that wants to change keys must notify its parent name server so that the parent can change the DS record (which endorses the child’s public key). As it turns out, this process is difficult to perform securely and can easily go wrong.</p> <p>To minimize the use of this difficult key change protocol, each DNSSEC name server generates two public/private key pairs. The <strong>key signing key (KSK)</strong> is only used to sign the zone signing key, and the <strong>zone signing key (ZSK)</strong> is used to sign everything else.</p> <p><img src="/assets/images/network/dnssec/zsk.png" alt="Diagram depicting a ZSK used to sign records" /></p> <p>In our previous design with one key pair, the name server sends (1) a set of records, (2) a signature on those records, and (3) the public key (endorsed by the parent). The DNS resolver uses the public key to verify the signature, and accepts the set of records.</p> <p><img src="/assets/images/network/dnssec/ksk.png" alt="Diagram depicting a KSK used to sign a ZSK, which is then used to sign records" /></p> <p>In our new design with two key pairs, the name server sends (1) the public ZSK, (2) a signature on the public ZSK, and (3) the public KSK (endorsed by the parent). The DNS resolver uses the public KSK to verify the signature, and accepts the public ZSK. Note that this is the exact same structure that was used to sign records before, but in this case, the record is the public ZSK, signed using the KSK.</p> <p>Another way to think about this step is to recall that a parent endorses a child by signing its public key. You can think of the KSK as the “parent” and the ZSK as the “child,” both within one name server. The parent (KSK) endorses the child (ZSK) by signing the public ZSK.</p> <p>The result of this first step is that we now have a trusted public ZSK. The second step is the same as before: the name server sends a set of records, a signature on those records (using the private ZSK), and the public ZSK (endorsed by the KSK in the previous step).</p> <p><img src="/assets/images/network/dnssec/dnssec.png" alt="Diagram of the full chain of trust in DNSSEC. The trust anchor is the root's KSK, which is used to sign the root's ZSK, which is used to sign .edu's KSK, which is used to sign .edu's ZSK, which is used to sign berkeley.edu's KSK, which is used to sign berkeley.edu's ZSK, which is used to sign berkeley.edu's A record" /></p> <p>Here is a diagram of the entire two-key DNSSEC. Each color (blue, green, orange) represents a name server. The lighter shade represents records signed with the KSK. The darker shade represents records signed with the ZSK.</p> <p>Verification would proceed as follows.</p> <ul> <li> <p>Light blue: Because of our trust anchor, we trust the KSK of the root (1). The root’s KSK signs its ZSK, so now we trust the root’s ZSK (2-3).</p> </li> <li> <p>Dark blue: We trust the root’s ZSK. The root’s ZSK signs <code class="language-plaintext highlighter-rouge">.edu</code>’s KSK (4-5), so now we trust <code class="language-plaintext highlighter-rouge">.edu</code>’s KSK.</p> </li> <li> <p>Light green: We trust the <code class="language-plaintext highlighter-rouge">.edu</code>’s KSK (6). <code class="language-plaintext highlighter-rouge">.edu</code>’s KSK signs <code class="language-plaintext highlighter-rouge">.edu</code>’s ZSK, so now we trust <code class="language-plaintext highlighter-rouge">.edu</code>’s ZSK (7-8).</p> </li> <li> <p>Dark green: We trust <code class="language-plaintext highlighter-rouge">.edu</code>’s ZSK. <code class="language-plaintext highlighter-rouge">.edu</code>’s ZSK signs <code class="language-plaintext highlighter-rouge">berkeley.edu</code>’s KSK (9-10), so now we trust <code class="language-plaintext highlighter-rouge">berkeley.edu</code>’s KSK.</p> </li> <li> <p>Light orange: We trust the <code class="language-plaintext highlighter-rouge">berkeley.edu</code>’s KSK (11). <code class="language-plaintext highlighter-rouge">berkeley.edu</code>’s KSK signs <code class="language-plaintext highlighter-rouge">berkeley.edu</code>’s ZSK, so now we trust <code class="language-plaintext highlighter-rouge">berkeley.edu</code>’s ZSK (12-13).</p> </li> <li> <p>Dark orange: We trust <code class="language-plaintext highlighter-rouge">berkeley.edu</code>’s ZSK. <code class="language-plaintext highlighter-rouge">berkeley.edu</code>’s ZSK signs the final answer record (14-15), so now we trust the final answer.</p> </li> </ul> <h2 id="336-dnssec-query-walkthrough"> <a href="#336-dnssec-query-walkthrough" class="anchor-heading" aria-labelledby="336-dnssec-query-walkthrough"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 33.6. DNSSEC query walkthrough </h2> <p>Now we’re ready to see a full DNSSEC query in action. As before, you can try this at home with the <a href="https://en.wikipedia.org/wiki/Dig_(command)"><code class="language-plaintext highlighter-rouge">dig</code> utility</a>–remember to set the <code class="language-plaintext highlighter-rouge">+norecurse</code> flag so you can unravel the recursion yourself, and remember to set the <code class="language-plaintext highlighter-rouge">+dnssec</code> flag to enable DNSSEC.</p> <p>First, we query the root server for its public keys. Recall that the root’s IP address, <code class="language-plaintext highlighter-rouge">198.41.0.4</code>, is publicly-known and hardcoded.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dig +norecurse +dnssec DNSKEY . @198.41.0.4

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 7149
;; flags: qr aa; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 1472
;; QUESTION SECTION:
;.             IN    DNSKEY

;; ANSWER SECTION:
.    172800    IN    DNSKEY    256 {ZSK of root}
.    172800    IN    DNSKEY    257 {KSK of root}
.    172800    IN    RRSIG     DNSKEY {signature on DNSKEY records}
...
</code></pre></div></div> <p>In this response, the root has returned its public ZSK, public KSK, and a <code class="language-plaintext highlighter-rouge">RRSIG</code> type record over the two <code class="language-plaintext highlighter-rouge">DNSKEY</code> type records. We can use the public KSK to verify the signature on the public ZSK.</p> <p>Because we implicitly trust the root’s KSK (trust anchor), and the root’s KSK signs its ZSK, we now trust the root’s ZSK.</p> <p>Next, we query the root server for the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dig +norecurse +dnssec eecs.berkeley.edu @198.41.0.4

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 5232
;; flags: qr; QUERY: 1, ANSWER: 0, AUTHORITY: 15, ADDITIONAL: 27

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 4096
;; QUESTION SECTION:
;eecs.berkeley.edu.           IN   A

;; AUTHORITY SECTION:
edu.                 172800   IN   NS      a.edu-servers.net.
edu.                 172800   IN   NS      b.edu-servers.net.
edu.                 172800   IN   NS      c.edu-servers.net.
...
edu.                 86400    IN   DS      {hash of .edu's KSK}
edu.                 86400    IN   RRSIG   DS {signature on DS record}

;; ADDITIONAL SECTION:
a.edu-servers.net.   172800   IN   A       192.5.6.30
b.edu-servers.net.   172800   IN   A       192.33.14.30
c.edu-servers.net.   172800   IN   A       192.26.92.30
...
</code></pre></div></div> <p>DNSSEC doesn’t remove any records compared to regular DNS–the question, answer (blank here), authority, and additional sections all contain the same records from regular DNS. However, DNSSEC adds a <code class="language-plaintext highlighter-rouge">DS</code> record and a <code class="language-plaintext highlighter-rouge">RRSIG</code> signature record on the <code class="language-plaintext highlighter-rouge">DS</code> record. Together, these two records sign the KSK of the <code class="language-plaintext highlighter-rouge">.edu</code> name server with the root’s ZSK. Since we trust the root’s ZSK (from the previous step), now we trust the <code class="language-plaintext highlighter-rouge">.edu</code> name server’s KSK.</p> <p>Next, we query the <code class="language-plaintext highlighter-rouge">.edu</code> name server for its public keys.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dig +norecurse +dnssec DNSKEY edu. @192.5.6.30

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 9776
;; flags: qr aa; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 4096
;; QUESTION SECTION:
;edu.          IN   DNSKEY

;; ANSWER SECTION:
edu.   86400   IN   DNSKEY  256 {ZSK of .edu}
edu.   86400   IN   DNSKEY  257 {KSK of .edu}
edu.   86400   IN   RRSIG   DNSKEY {signature on DNSKEY records}
...
</code></pre></div></div> <p>In this response, the <code class="language-plaintext highlighter-rouge">.edu</code> name server has returned its public ZSK, public KSK, and a <code class="language-plaintext highlighter-rouge">RRSIG</code> type record over the two <code class="language-plaintext highlighter-rouge">DNSKEY</code> type records. We can use the public KSK to verify the signature on the public ZSK.</p> <p>Because we trust the <code class="language-plaintext highlighter-rouge">.edu</code> name server’s KSK (from the previous step), and the <code class="language-plaintext highlighter-rouge">.edu</code> KSK signs its ZSK, we now trust the <code class="language-plaintext highlighter-rouge">.edu</code> name server’s ZSK.</p> <p>Next, we query the <code class="language-plaintext highlighter-rouge">.edu</code> name server for the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dig +norecurse +dnssec eecs.berkeley.edu @192.5.6.30

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 60799
;; flags: qr; QUERY: 1, ANSWER: 0, AUTHORITY: 5, ADDITIONAL: 5

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 4096
;; QUESTION SECTION:
;eecs.berkeley.edu.          IN  A

;; AUTHORITY SECTION:
berkeley.edu.        172800  IN  NS     adns1.berkeley.edu.
berkeley.edu.        172800  IN  NS     adns2.berkeley.edu.
berkeley.edu.        172800  IN  NS     adns3.berkeley.edu.
berkeley.edu.        86400   IN  DS     {hash of berkeley.edu's KSK}
berkeley.edu.        86400   IN  RRSIG  DS {signature on DS record}

;; ADDITIONAL SECTION:
adns1.berkeley.edu.  172800  IN  A      128.32.136.3
adns2.berkeley.edu.  172800  IN  A      128.32.136.14
adns3.berkeley.edu.  172800  IN  A      192.107.102.142
...
</code></pre></div></div> <p>In this response, the <code class="language-plaintext highlighter-rouge">.edu</code> name server returns <code class="language-plaintext highlighter-rouge">NS</code> and <code class="language-plaintext highlighter-rouge">A</code> type records that tell us what name server to query next, just like in regular DNS.</p> <p>In addition, the response has a <code class="language-plaintext highlighter-rouge">DS</code> type record and an <code class="language-plaintext highlighter-rouge">RRSIG</code> signature on the <code class="language-plaintext highlighter-rouge">DS</code> record. Sanity check: which key is used to sign the <code class="language-plaintext highlighter-rouge">DS</code> record?<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> Together, these two records sign the KSK of the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server. Because we trust the <code class="language-plaintext highlighter-rouge">.edu</code> name server’s ZSK (from the previous step), and the <code class="language-plaintext highlighter-rouge">.edu</code> ZSK signs the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> KSK, we now trust the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server’s KSK.</p> <p>Next, we query the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server for its public keys.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dig +norecurse +dnssec DNSKEY berkeley.edu @128.32.136.3

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 4169
;; flags: qr aa; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 1220
;; QUESTION SECTION:
;berkeley.edu.         IN  DNSKEY

;; ANSWER SECTION:
berkeley.edu.  172800  IN  DNSKEY  256 {ZSK of berkeley.edu}
berkeley.edu.  172800  IN  DNSKEY  257 {KSK of berkeley.edu}
berkeley.edu.  172800  IN  RRSIG   DNSKEY {signature on DNSKEY records}
...
</code></pre></div></div> <p>In this response, the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server has returned its public ZSK, public KSK, and a <code class="language-plaintext highlighter-rouge">RRSIG</code> type record over the two <code class="language-plaintext highlighter-rouge">DNSKEY</code> type records. We can use the public KSK to verify the signature on the public ZSK.</p> <p>Because we trust the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server’s KSK (from the previous step), and the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> KSK signs its ZSK, we now trust the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server’s ZSK.</p> <p>Finally, we query the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server for the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dig +norecurse +dnssec eecs.berkeley.edu @128.32.136.3

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 21205
;; flags: qr aa; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags: do; udp: 1220
;; QUESTION SECTION:
;eecs.berkeley.edu.         IN  A

;; ANSWER SECTION:
eecs.berkeley.edu.  86400   IN  A      23.185.0.1
eecs.berkeley.edu.  86400   IN  RRSIG  A {signature on A record}
</code></pre></div></div> <p>This response has the final answer <code class="language-plaintext highlighter-rouge">A</code> type record and a signature on the final answer. Because we trust the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server’s ZSK (from the previous part), we also trust the final answer.</p> <h2 id="337-nonexistent-domains"> <a href="#337-nonexistent-domains" class="anchor-heading" aria-labelledby="337-nonexistent-domains"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 33.7. Nonexistent domains </h2> <p>Remember that DNS is designed to be fast and lightweight. However, public-key cryptography is slow, because it requires math. As a result, name servers that support DNSSEC sign records <em>offline</em>–records are signed ahead of time, and the signatures saved in the server along with the records. When the server receives a DNS query, it can immediately return the saved signature without computing it.</p> <p>Offline signing works fine for existing domains, but what if we receive a request for a nonxistent domain? There are infinitely many nonexistent domains, so we cannot sign them all offline. However, we cannot sign requests for nonexistent domains <em>online</em> either, because this is too slow. Also, online cryptography makes name servers vulnerable to an attack. Sanity check: what’s the attack?<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup></p> <p>DNSSEC has a clever solution to this problem–instead of signing individual nonexistent domains, name servers pre-compute signatures on <em>ranges</em> of nonexistent domains. Suppose we have a website with three subdomains:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>b.example.com
l.example.com
q.example.com
</code></pre></div></div> <p>If we sort every possible subdomain alphabetically, there are three ranges of nonexistent domains: everything between <code class="language-plaintext highlighter-rouge">b</code> and <code class="language-plaintext highlighter-rouge">l</code>, <code class="language-plaintext highlighter-rouge">l</code> and <code class="language-plaintext highlighter-rouge">q</code>, and <code class="language-plaintext highlighter-rouge">q</code> and <code class="language-plaintext highlighter-rouge">b</code> (wrapping around from z to a).</p> <p>Now, if someone queries for <code class="language-plaintext highlighter-rouge">c.example.com</code>, instead of signing a message proving the nonexistence of that specific domain, the name server returns a <strong>NSEC record</strong> saying, “No domains exist between <code class="language-plaintext highlighter-rouge">b.example.com</code> and <code class="language-plaintext highlighter-rouge">l.example.com</code>. Signed, name server.”</p> <p>NSEC records have a slight vulnerability - notice that every time we query for a nonexistent domain, we can discover two valid domains that we might have otherwise not known. By traversing the alphabet, an attacker can now learn the names of every subdomain of the website:</p> <ol> <li> <p>Query <code class="language-plaintext highlighter-rouge">c.example.com</code>. Receive NSEC saying nothing exists between <code class="language-plaintext highlighter-rouge">b</code> and <code class="language-plaintext highlighter-rouge">l</code>. Attacker now knows <code class="language-plaintext highlighter-rouge">b</code> and <code class="language-plaintext highlighter-rouge">l</code> exist.</p> </li> <li> <p>Query <code class="language-plaintext highlighter-rouge">m.example.com</code>. Receive NSEC saying nothing exists between <code class="language-plaintext highlighter-rouge">l</code> and <code class="language-plaintext highlighter-rouge">q</code>. Attacker now knows <code class="language-plaintext highlighter-rouge">q</code> exists.</p> </li> <li> <p>Query <code class="language-plaintext highlighter-rouge">r.example.com</code>. Receive NSEC saying nothing exists between <code class="language-plaintext highlighter-rouge">q</code> and <code class="language-plaintext highlighter-rouge">b</code>. Attacker has already seen <code class="language-plaintext highlighter-rouge">b</code>, so they know they have walked the entire alphabet successfully.</p> </li> </ol> <p>Some argue that this is not really a vulnerability, because hiding a domain name like <code class="language-plaintext highlighter-rouge">admin.example.com</code> is relying on security through obscurity. Nevertheless, an attempt to fix this was implemented as <strong>NSEC3</strong>, which simply uses the hashes of every domain name instead of the actual domain name.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>372fbe338b9f3bb6f857352bc4c6a49721d6066f (l.example.com)
6898bc7daf3054daae05e8763153ee1506e809d5 (q.example.com)
f96a6ec2fb6efbe43002f4cbf124f90879424d79 (b.example.com)
</code></pre></div></div> <p>The order of the domain names has changed, but the process is the same - if someone queries for <code class="language-plaintext highlighter-rouge">c.example.com</code>, which hashes to <code class="language-plaintext highlighter-rouge">8dca64e4b6e1724f0d84c5c25c9354d5529ab0a2</code>, the NSEC3 record will say, “No domains exist that hash to values between <code class="language-plaintext highlighter-rouge">6898b...</code> and <code class="language-plaintext highlighter-rouge">f96a6...</code>. Signed, name server.”</p> <p>Of course, an attacker could buy a GPU and precompute hashes to learn domain names anyway… and <a href="https://datatracker.ietf.org/doc/draft-vcelak-nsec5/">NSEC5</a> was born. Fortunately, it’s still out of scope for this class.</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1" role="doc-endnote"> <p>A: DNS responses don’t contain sensitive data. Anyone could query the name servers for the same information. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:2" role="doc-endnote"> <p>A: The ZSK of the <code class="language-plaintext highlighter-rouge">.edu</code> name server. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:3" role="doc-endnote"> <p>A: Denial of service (DoS). Flood the name server with requests for nonexistent domains, and it will be forced to sign all of them. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
