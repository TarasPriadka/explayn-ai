<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>32. DNS - Computer Security</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>DNS | Computer Security</title> <meta name="generator" content="Jekyll v3.9.2" /> <meta property="og:title" content="DNS" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Online textbook for CS 161: Computer Security at UC Berkeley." /> <meta property="og:description" content="Online textbook for CS 161: Computer Security at UC Berkeley." /> <link rel="canonical" href="/network/dns.html" /> <meta property="og:url" content="/network/dns.html" /> <meta property="og:site_name" content="Computer Security" /> <meta property="og:type" content="website" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="DNS" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Online textbook for CS 161: Computer Security at UC Berkeley.","headline":"DNS","url":"/network/dns.html"}</script> <!-- End Jekyll SEO tag --> <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML" ></script> <script> let toggleDark = () => { let setDark = jtd.getTheme() !== 'dark'; jtd.setTheme(setDark ? 'dark' : 'default'); localStorage.setItem('darkMode', String(setDark)); }; window.addEventListener('DOMContentLoaded', () => { /* Add event to dark mode button. */ let a = document.getElementsByClassName('site-button')[2]; a.addEventListener('click', (e) => { e.preventDefault(); toggleDark(); }); /* Read local storage state. */ if (localStorage.getItem('darkMode') === 'true') { toggleDark(); } }); </script> </head> <body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <!-- Feather. MIT License: https://github.com/feathericons/feather/blob/master/LICENSE --> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"> <title id="svg-external-link-title">(external link)</title> <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Computer Security </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Introduction</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Security Principles category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/principles/" class="nav-list-link">Security Principles</a><ul class="nav-list "><li class="nav-list-item "><a href="/principles/principles.html" class="nav-list-link">1. Security Principles</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Memory Safety category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/memory-safety/" class="nav-list-link">Memory Safety</a><ul class="nav-list "><li class="nav-list-item "><a href="/memory-safety/x86.html" class="nav-list-link">2. x86 Assembly and Call Stack</a></li><li class="nav-list-item "><a href="/memory-safety/vulnerabilities.html" class="nav-list-link">3. Memory Safety Vulnerabilities</a></li><li class="nav-list-item "><a href="/memory-safety/mitigations.html" class="nav-list-link">4. Mitigating Memory-Safety Vulnerabilities</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Cryptography category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/crypto/" class="nav-list-link">Cryptography</a><ul class="nav-list "><li class="nav-list-item "><a href="/crypto/intro.html" class="nav-list-link">5. Introduction to Cryptography</a></li><li class="nav-list-item "><a href="/crypto/symmetric.html" class="nav-list-link">6. Symmetric-Key Cryptography</a></li><li class="nav-list-item "><a href="/crypto/hashes.html" class="nav-list-link">7. Cryptographic Hashes</a></li><li class="nav-list-item "><a href="/crypto/macs.html" class="nav-list-link">8. Message Authentication Codes (MACs)</a></li><li class="nav-list-item "><a href="/crypto/prng.html" class="nav-list-link">9. Pseudorandom Number Generators</a></li><li class="nav-list-item "><a href="/crypto/key-exchange.html" class="nav-list-link">10. Diffie-Hellman Key Exchange</a></li><li class="nav-list-item "><a href="/crypto/public-key.html" class="nav-list-link">11. Public-Key Encryption</a></li><li class="nav-list-item "><a href="/crypto/signatures.html" class="nav-list-link">12. Digital Signatures</a></li><li class="nav-list-item "><a href="/crypto/certificates.html" class="nav-list-link">13. Certificates</a></li><li class="nav-list-item "><a href="/crypto/passwords.html" class="nav-list-link">14. Passwords</a></li><li class="nav-list-item "><a href="/crypto/case-studies.html" class="nav-list-link">15. Case Studies</a></li><li class="nav-list-item "><a href="/crypto/bitcoin.html" class="nav-list-link">16. Bitcoin</a></li></ul></li><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in Web Security category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/web/" class="nav-list-link">Web Security</a><ul class="nav-list "><li class="nav-list-item "><a href="/web/sqli.html" class="nav-list-link">17. SQL Injection</a></li><li class="nav-list-item "><a href="/web/intro.html" class="nav-list-link">18. Introduction to the Web</a></li><li class="nav-list-item "><a href="/web/sop.html" class="nav-list-link">19. Same-Origin Policy</a></li><li class="nav-list-item "><a href="/web/cookies.html" class="nav-list-link">20. Cookies and Session Management</a></li><li class="nav-list-item "><a href="/web/csrf.html" class="nav-list-link">21. Cross-Site Request Forgery (CSRF)</a></li><li class="nav-list-item "><a href="/web/xss.html" class="nav-list-link">22. Cross-Site Scripting (XSS)</a></li><li class="nav-list-item "><a href="/web/ui-attacks.html" class="nav-list-link">23. UI Attacks</a></li><li class="nav-list-item "><a href="/web/captchas.html" class="nav-list-link">24. CAPTCHAs</a></li></ul></li><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in Network Security category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/network/" class="nav-list-link">Network Security</a><ul class="nav-list "><li class="nav-list-item "><a href="/network/intro.html" class="nav-list-link">25. Introduction to Networking</a></li><li class="nav-list-item "><a href="/network/arp.html" class="nav-list-link">26. ARP</a></li><li class="nav-list-item "><a href="/network/wpa.html" class="nav-list-link">27. WPA</a></li><li class="nav-list-item "><a href="/network/dhcp.html" class="nav-list-link">28. DHCP</a></li><li class="nav-list-item "><a href="/network/bgp.html" class="nav-list-link">29. BGP</a></li><li class="nav-list-item "><a href="/network/transport.html" class="nav-list-link">30. TCP and UDP</a></li><li class="nav-list-item "><a href="/network/tls.html" class="nav-list-link">31. TLS</a></li><li class="nav-list-item active"><a href="/network/dns.html" class="nav-list-link active">32. DNS</a></li><li class="nav-list-item "><a href="/network/dnssec.html" class="nav-list-link">33. DNSSEC</a></li><li class="nav-list-item "><a href="/network/dos.html" class="nav-list-link">34. Denial-of-Service (DoS)</a></li><li class="nav-list-item "><a href="/network/firewalls.html" class="nav-list-link">35. Firewalls</a></li><li class="nav-list-item "><a href="/network/intrusion-detection.html" class="nav-list-link">36. Intrusion Detection</a></li><li class="nav-list-item "><a href="/network/abusing-intrusion-detection.html" class="nav-list-link">37. Abusing Intrusion Detection</a></li><li class="nav-list-item "><a href="/network/malware.html" class="nav-list-link">38. Malware</a></li><li class="nav-list-item "><a href="/network/tor.html" class="nav-list-link">39. Anonymity and Tor</a></li></ul></li><li class="nav-list-item"><a href="/glossary.html" class="nav-list-link">Glossary</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Computer Security" aria-label="Search Computer Security" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://cs161.org" class="site-button" > CS 161 </a> </li> <li class="aux-nav-list-item"> <a href="#" class="site-button" > Dark Mode </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/network/">Network Security</a></li> <li class="breadcrumb-nav-list-item"><span>32. DNS</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="32-dns"> <a href="#32-dns" class="anchor-heading" aria-labelledby="32-dns"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 32. DNS </h1> <p>The Internet is commonly indexed in two different ways. Humans refer to websites using human-readable names such as <code class="language-plaintext highlighter-rouge">google.com</code> and <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>, while computers refer to websites using IP addresses such as <code class="language-plaintext highlighter-rouge">172.217.4.174</code> and <code class="language-plaintext highlighter-rouge">23.195.69.108</code>. <strong>DNS</strong>, or the <strong>Domain Name System</strong>, is the protocol that translates between the two.</p> <h2 id="321-name-servers"> <a href="#321-name-servers" class="anchor-heading" aria-labelledby="321-name-servers"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 32.1. Name servers </h2> <p>It would be great if there was single server that stored a mapping from every domain to every IP address that everyone could query, but unfortunately, there is no server big enough to store the IP address of every domain on the Internet and fast enough to handle the volume of DNS requests generated by the entire world. Instead, DNS uses a collection of many <strong>name servers</strong>, which are servers dedicated to replying to DNS requests.</p> <p>Each name server is responsible for a specific zone of domains, so that no single server needs to store every domain on the Internet. For example, a name server responsible for the <code class="language-plaintext highlighter-rouge">.com</code> zone only needs to answer queries for domains that end in <code class="language-plaintext highlighter-rouge">.com</code>. This name server doesn’t need to store any DNS information related to <code class="language-plaintext highlighter-rouge">wikipedia.org</code>. Likewise, a name server responsible for the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> zone doesn’t need to store any DNS information related to <code class="language-plaintext highlighter-rouge">stanford.edu</code>.</p> <p>Even though it has a special purpose (responding to DNS requests), a name server is just like any other server you can contact on the Internet–each one has a human-readable domain name (e.g. <code class="language-plaintext highlighter-rouge">a.edu-servers.net</code>) and a computer-readable IP address (e.g. <code class="language-plaintext highlighter-rouge">192.5.6.30</code>). Be careful not to confuse the domain name with the zone. For example, this name server has <code class="language-plaintext highlighter-rouge">.net</code> in its domain, but it responds to DNS requests for <code class="language-plaintext highlighter-rouge">.edu</code> domains.</p> <h2 id="322-name-server-hierarchy"> <a href="#322-name-server-hierarchy" class="anchor-heading" aria-labelledby="322-name-server-hierarchy"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 32.2. Name server hierarchy </h2> <p>You might notice two problems with this design. First, the <code class="language-plaintext highlighter-rouge">.com</code> zone may be smaller than the entire Internet, but it is still impractical for one name server to store all domains ending in <code class="language-plaintext highlighter-rouge">.com</code>. Second, if there are many name servers, how does your computer know which one to contact?</p> <p>DNS solves both of these problems by introducing a new idea: when you query a name server, instead of always returning the IP address of the domain you queried, the name server can also direct you to another name server for the answer. This allows name servers with large zones such as <code class="language-plaintext highlighter-rouge">.edu</code> to redirect your query to other name servers with smaller zones such as <code class="language-plaintext highlighter-rouge">berkeley.edu</code>. Now, the name server for the <code class="language-plaintext highlighter-rouge">.edu</code> zone doesn’t need to store any information about <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>, <code class="language-plaintext highlighter-rouge">math.berkeley.edu</code>, etc. Instead, the <code class="language-plaintext highlighter-rouge">.edu</code> name server stores information about the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server and redirects requests for <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>, <code class="language-plaintext highlighter-rouge">math.berkeley.edu</code>, etc. to a <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server.</p> <p>DNS arranges all the name servers in a tree hierarchy based on their zones:</p> <p><img src="/assets/images/network/dns/dnstree.png" alt="Diagram of an example DNS tree, with the root at the root, the top-level domains .edu, .org, and .com as the second level, and second-level domains such as berkeley.edu, cs161.org, and google.com at the third level" /></p> <p>The <strong>root server</strong> at the top level of the tree has all domains in its zone (this zone is usually written as <code class="language-plaintext highlighter-rouge">.</code>). Name servers at lower levels of the tree have smaller, more specific zones. Each name server is only responsible for storing information about their children, except for the name servers at the bottom of the tree, which are responsible for storing the actual mappings from domain names to IP addresses.</p> <p>DNS queries always start at the root. The root will direct your query to one of its children name servers. Then you make a query to the child name server, and that name server redirects you to one of its children. The process repeats until you make a query to a name server at the bottom of the tree, which will return the IP address corresponding to your domain.</p> <p>To redirect you to a child name server, the parent name server must provide the child’s zone, human-readable domain name, and IP address, so that you can contact that child name server for more information.</p> <p>As an example, a DNS query for <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code> might have the following steps. (A comic version of this query is available at <a href="https://howdns.works/">https://howdns.works/</a>.)</p> <p><img src="/assets/images/network/dns/dnsquery.png" alt="Diagram of a recursive DNS query, where your resolver queries the root nameserver first in query 1 and response 2, then the nameserver at the second level of the tree in query 3 and response 4, then a nameserver at the third level of the tree in query 5 and response 6" /></p> <ol> <li> <p>You to the root name server: Please tell me the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>.</p> </li> <li> <p>Root server to you: I don’t know, but I can redirect you to another name server with more information. This name server is responsible for the <code class="language-plaintext highlighter-rouge">.edu</code> zone. It has human-readable domain name <code class="language-plaintext highlighter-rouge">a.edu-servers.net</code> and IP address <code class="language-plaintext highlighter-rouge">192.5.6.30</code>.</p> </li> <li> <p>You to the <code class="language-plaintext highlighter-rouge">.edu</code> name server: Please tell me the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>.</p> </li> <li> <p>The <code class="language-plaintext highlighter-rouge">.edu</code> name server to you: I don’t know, but I can redirect you to another name server with more information. This name server is responsible for the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> zone. It has human-readable domain name <code class="language-plaintext highlighter-rouge">adns1.berkeley.edu</code> and IP address <code class="language-plaintext highlighter-rouge">128.32.136.3</code>.</p> </li> <li> <p>You to the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server: Please tell me the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>.</p> </li> <li> <p>The <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server to you: OK, the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code> is <code class="language-plaintext highlighter-rouge">23.185.0.1</code>.</p> </li> </ol> <p>A note on who is actually sending the DNS queries in this example: Your computer can manually perform DNS lookups, but in practice, your local computer usually delegates the task of DNS lookups to a <strong>DNS Recursive Resolver</strong> provided by your Internet service provider (ISP), which sends the queries, processes the responses, and maintains an internal cache of records. When performing a lookup, the <strong>DNS Stub Resolver</strong> on your computer sends a query to the recursive resolver, lets it do all the work, and receives the response. When thinking about DNS requests, you can usually focus on the messages being sent between the recursive resolver and the name server.</p> <p>Congratulations, you now understand how DNS translates domains to IP addresses! The rest of this section describes the specific implementation details of DNS.</p> <h2 id="323-dns-message-format"> <a href="#323-dns-message-format" class="anchor-heading" aria-labelledby="323-dns-message-format"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 32.3 DNS Message Format </h2> <p>Since every website lookup must start with a DNS query, DNS is designed to be very lightweight and fast - it uses UDP (best-effort packets, no TCP handshakes) and has a fairly simple message format.</p> <p>TODO: This diagram can be better. ~NN</p> <div class="table-wrapper"><table> <thead> <tr> <th>16 bits</th> <th>16 bits</th> </tr> </thead> <tbody> <tr> <td style="text-align: center">Identification</td> <td style="text-align: center">Flags</td> </tr> <tr> <td style="text-align: center"># Questions</td> <td style="text-align: center"># Answer RRs</td> </tr> <tr> <td style="text-align: center"># Authority RRs</td> <td style="text-align: center"># Additional RRs</td> </tr> <tr> <td style="text-align: center" colspan="2">Questions (variable # of RRs)</td> </tr> <tr> <td style="text-align: center" colspan="2">Answers (variable # of RRs)</td> </tr> <tr> <td style="text-align: center" colspan="2">Authority (variable # of RRs)</td> </tr> <tr> <td style="text-align: center" colspan="2">Additional info (variable # of RRs)</td> </tr> </tbody> </table></div> <p>The first field is a 16 bit <strong>identification field</strong> that is randomly selected per query and used to match requests to responses. When a DNS query is sent, the ID field is filled with random bits. Since UDP is stateless, the DNS response must send back the same bits in the ID field so that the original query sender knows which DNS query the response corresponds to.</p> <p>Sanity check: Which type(s) of adversary can read this ID field? Which type(s) of adversary cannot read the ID field and must guess it when attacking DNS?<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup></p> <p>The next 16 bits are reserved for flags, which specify whether the message is a query or a response, as well as whether the query was successful (e.g. the <code class="language-plaintext highlighter-rouge">NOERROR</code> flag is set in the reply if the query succeeded, the <code class="language-plaintext highlighter-rouge">NXDOMAIN</code> flag is set in the reply if the query asked about a non-existent name).</p> <p>The next field specifies the number of questions asked (in practice, this is always 1). The three fields after that are used in response messages and specify the number of <strong>resource records</strong> (RRs) contained in the message. We’ll describe each of these categories of RRs in depth later.</p> <p>The rest of the message contains the actual content of the DNS query/response. This content is always structured as a set of RRs, where each RR is a key-value pair with an associated type.</p> <p>For completeness, a DNS record key is formally defined as a 3-tuple <code class="language-plaintext highlighter-rouge">&lt;Name, Class, Type&gt;</code>, where <code class="language-plaintext highlighter-rouge">Name</code> is the actual key data, <code class="language-plaintext highlighter-rouge">Class</code> is always <code class="language-plaintext highlighter-rouge">IN</code> for Internet (except for special queries used to get information about DNS itself), and <code class="language-plaintext highlighter-rouge">Type</code> specifies the record type. A DNS record value contains <code class="language-plaintext highlighter-rouge">&lt;TTL, Value&gt;</code>, where <code class="language-plaintext highlighter-rouge">TTL</code> is the time-to-live (how long, in seconds, the record can be cached), and <code class="language-plaintext highlighter-rouge">Value</code> is the actual value data.</p> <p>There are two main types of records in DNS. <strong>A type records</strong> map domains to IP addresses. The key is a domain, and the value is an IP address. <strong>NS type records</strong> map zones to domains. The key is a zone, and the value is a domain.</p> <p>Important takeaways from this section: Each DNS packet has a 16-bit random ID field, some metadata, and a set of resource records. Each record falls into one of four categories (question, answer, authority, additional), and each record contains a type, a key, and a value. There are A type records and NS type records.</p> <h2 id="324-dns-lookup"> <a href="#324-dns-lookup" class="anchor-heading" aria-labelledby="324-dns-lookup"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 32.4. DNS Lookup </h2> <p>Now, let’s walk through a real DNS query for the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>. You can try this at home with the <a href="https://en.wikipedia.org/wiki/Dig_(command)"><code class="language-plaintext highlighter-rouge">dig</code> utility</a>–remember to set the <code class="language-plaintext highlighter-rouge">+norecurse</code> flag so you can unravel the recursion yourself.</p> <p>Every DNS query begins with the root server. For redundancy, there are actually 13 root servers located around the world. We can look up the <a href="https://www.iana.org/domains/root/servers">IP addresses</a> of the root servers, which are public and well-known. In a real recursive resolver, these addresses are usually hardcoded.</p> <p>The first root server has domain <code class="language-plaintext highlighter-rouge">a.root-servers.net</code> and IP address <code class="language-plaintext highlighter-rouge">198.41.0.4</code>. We can use <code class="language-plaintext highlighter-rouge">dig</code> to send a DNS request to this address, asking for the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dig +norecurse eecs.berkeley.edu @198.41.0.4

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 26114
;; flags: qr; QUERY: 1, ANSWER: 0, AUTHORITY: 13, ADDITIONAL: 27

;; QUESTION SECTION:
;eecs.berkeley.edu.          IN   A

;; AUTHORITY SECTION:
edu.                172800   IN   NS   a.edu-servers.net.
edu.                172800   IN   NS   b.edu-servers.net.
edu.                172800   IN   NS   c.edu-servers.net.
...

;; ADDITIONAL SECTION:
a.edu-servers.net.  172800   IN   A    192.5.6.30
b.edu-servers.net.  172800   IN   A    192.33.14.30
c.edu-servers.net.  172800   IN   A    192.26.92.30
...
</code></pre></div></div> <p>In the first section of the answer, we can see the header information, including the ID field (<code class="language-plaintext highlighter-rouge">26114</code>), the return flags (<code class="language-plaintext highlighter-rouge">NOERROR</code>), and the number of records returned in each section.</p> <p>The <strong>question section</strong> contains 1 record (you can verify by seeing <code class="language-plaintext highlighter-rouge">QUERY: 1</code> in the header). It has key <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code>, type <code class="language-plaintext highlighter-rouge">A</code>, and a blank value. This represents the domain we queried for (the value is blank because we don’t know the corresponding IP address).</p> <p>The <strong>answer section</strong> is blank (<code class="language-plaintext highlighter-rouge">ANSWER: 0</code> in the header), because the root server didn’t provide a direct answer to our query.</p> <p>The <strong>authority section</strong> contains 13 records. The first one has key <code class="language-plaintext highlighter-rouge">.edu</code>, type <code class="language-plaintext highlighter-rouge">NS</code>, and value <code class="language-plaintext highlighter-rouge">a.edu-servers.net</code>. This is the root server giving us the zone and the domain name of the next name server we should contact. Each record in this section corresponds to a potential name server we could ask next.</p> <p>The <strong>additional section</strong> contains 27 records. The first one has key <code class="language-plaintext highlighter-rouge">a.edu-servers.net</code>, type <code class="language-plaintext highlighter-rouge">A</code>, and value <code class="language-plaintext highlighter-rouge">192.5.6.30</code>. This is the root server giving us the IP address of the next name server by mapping a domain from the authority section to an IP address.</p> <p>Together, the authority section and additional section combined give us the zone, domain name, and IP address of the next name server. This information is spread across two sections to maintain the key-value structure of the DNS message.</p> <p>For completeness: <code class="language-plaintext highlighter-rouge">172800</code> is the TTL (time-to-live) for each record, set at 172,800 seconds = 48 hours here. The <code class="language-plaintext highlighter-rouge">IN</code> is the Internet class and can basically be ignored. Sometimes you will see records of type <code class="language-plaintext highlighter-rouge">AAAA</code>, which correspond to <a href="https://en.wikipedia.org/wiki/IPv6">IPv6</a> addresses (the usual <code class="language-plaintext highlighter-rouge">A</code> type records correspond to <a href="https://en.wikipedia.org/wiki/IPv4">IPv4</a> addresses).</p> <p>Sanity check: What name server do we query next? How do we know where that name server is located? What do we query that name server for?<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$$ dig +norecurse eecs.berkeley.edu @192.5.6.30

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 36257
;; flags: qr; QUERY: 1, ANSWER: 0, AUTHORITY: 3, ADDITIONAL: 5

;; QUESTION SECTION:
;eecs.berkeley.edu.           IN   A

;; AUTHORITY SECTION:
berkeley.edu.        172800   IN   NS   adns1.berkeley.edu.
berkeley.edu.        172800   IN   NS   adns2.berkeley.edu.
berkeley.edu.        172800   IN   NS   adns3.berkeley.edu.

;; ADDITIONAL SECTION:
adns1.berkeley.edu.  172800   IN   A    128.32.136.3
adns2.berkeley.edu.  172800   IN   A    128.32.136.14
adns3.berkeley.edu.  172800   IN   A    192.107.102.142
...
</code></pre></div></div> <p>The next query also has an empty answer section, with <code class="language-plaintext highlighter-rouge">NS</code> records in the authority section and <code class="language-plaintext highlighter-rouge">A</code> records in the additional section which give us the domains and IP addresses of name servers responsible for the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> zone.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dig +norecurse eecs.berkeley.edu @128.32.136.3

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 52788
;; flags: qr aa; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; QUESTION SECTION:
;eecs.berkeley.edu.         IN   A

;; ANSWER SECTION:
eecs.berkeley.edu.  86400   IN   A   23.185.0.1
</code></pre></div></div> <p>Finally, the last query gives us the IP address corresponding to <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code> in the form of a single <code class="language-plaintext highlighter-rouge">A</code> type record in the answer section.</p> <p>In practice, because the recursive resolver caches as many answers as possible, most queries can skip the first few steps and used cached records instead of asking root servers and high-level name servers like <code class="language-plaintext highlighter-rouge">.edu</code> every time. Caching helps speed up DNS, because fewer packets need to be sent across the network to translate a domain name to an IP address. Caching also helps reduce request load on the highest-level name servers.</p> <h2 id="325-dns-security-bailiwick"> <a href="#325-dns-security-bailiwick" class="anchor-heading" aria-labelledby="325-dns-security-bailiwick"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 32.5. DNS Security: Bailiwick </h2> <p>DNS is insecure against a malicious name server. For example, if a <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server was taken over by an attacker, it could send answer records that point to malicious IP addresses.</p> <p>However, a more dangerous exploit is using the additional section to poison the cache with even more malicious IP addresses. For example, this malicious DNS response would cause the resolver to associate <code class="language-plaintext highlighter-rouge">google.com</code> with an attacker-owned IP address <code class="language-plaintext highlighter-rouge">6.6.6.6</code>.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dig +norecurse eecs.berkeley.edu @192.5.6.30

...
;; ADDITIONAL SECTION:
adns1.berkeley.edu.  172800   IN   A    128.32.136.3
www.google.com       999999   IN   A    6.6.6.6
...
</code></pre></div></div> <p>To prevent any malicious name server from doing too much damage, resolvers implement <strong>bailiwick checking</strong>. With bailiwick checking, a name server is only allowed to provide records in its zone. This means that the <code class="language-plaintext highlighter-rouge">berkeley.edu</code> name server can only provide records for domains under <code class="language-plaintext highlighter-rouge">berkeley.edu</code> (not <code class="language-plaintext highlighter-rouge">stanford.edu</code>), the <code class="language-plaintext highlighter-rouge">.edu</code> name server can only provide records for domains under <code class="language-plaintext highlighter-rouge">.edu</code> (not <code class="language-plaintext highlighter-rouge">google.com</code>), and the root name servers can provide records for anything.</p> <h2 id="326-dns-security-on-path-attackers-and-off-path-attackers"> <a href="#326-dns-security-on-path-attackers-and-off-path-attackers" class="anchor-heading" aria-labelledby="326-dns-security-on-path-attackers-and-off-path-attackers"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 32.6. DNS Security: On-path attackers and off-path attackers </h2> <p>Against an on-path attacker, DNS is completely insecure - everything is sent over plaintext, so an attacker can read the request, construct a malicious response message with malicious records and the correct ID field, and race to send the malicious reply before the legitimate response. If the time-to-live (TTL) of the malicious records is set to a very high number, then the victim will cache those malicous records for a very long time.</p> <p>For both on-path and off-path attackers, if the legitimate response arrives before the fake response, it is cached. Caching limits the attacker to only a few tries per week, because future requests for that domain can reference the cache, so no DNS queries are sent. Since off-path attackers must guess the ID field with a \(1/2^{16}\) probability of success, and they only get a few tries per week, DNS was believed to be secure against off-path attackers, until Dan Kaminsky discovered a flaw in the DNS protocol in 2008. This attack was so severe that Kaminsky was awarded with a <a href="https://en.wikipedia.org/wiki/Dan_Kaminsky">Wikipedia article</a>.</p> <h2 id="327-dns-security-kaminsky-attack"> <a href="#327-dns-security-kaminsky-attack" class="anchor-heading" aria-labelledby="327-dns-security-kaminsky-attack"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 32.7. DNS Security: Kaminsky attack </h2> <p>The Kaminsky attack relies on querying for nonexistent domains. Remember that the legitimate response for a nonexistent domain is an <code class="language-plaintext highlighter-rouge">NXDOMAIN</code> status with no other records, which means that nothing is cached! This allows the attacker to repeatedly race until they win, without having to wait for cached records to expire.</p> <p>An attacker can now include malicious additional records in the fake response for the nonexistent <code class="language-plaintext highlighter-rouge">fake161.berkeley.edu</code>:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$$ dig fake161.berkeley.edu

;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 29439
;; flags: qr aa; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1

;; QUESTION SECTION:
;fake161.berkeley.edu.        IN  A

;; ADDITIONAL SECTION:
berkeley.edu.     999999    IN  A   6.6.6.6
</code></pre></div></div> <p>If the fake response arrives first, the resolver will cache the malicious additional record. Notice that this doesn’t violate bailiwick checking, since the name server responsible for answering <code class="language-plaintext highlighter-rouge">fake161.berkeley.edu</code> can provide a record for <code class="language-plaintext highlighter-rouge">berkeley.edu</code>.</p> <p>Now that the attacker can try as many times as they want, all that’s left is to force a victim to make thousands of DNS queries for nonexistent domains. This can be achieved by tricking the victim into visiting a website that tries to load lots of nonexistent domains:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;img src="http://fake001.berkeley.edu/image.jpg"/&gt;
&lt;img src="http://fake002.berkeley.edu/image.jpg"/&gt;
&lt;img src="http://fake003.berkeley.edu/image.jpg"/&gt;
...
</code></pre></div></div> <p>This HTML snippet will cause the victim’s browser to try and fetch images from <code class="language-plaintext highlighter-rouge">http://fake001.berkeley.edu/image.jpg</code>, <code class="language-plaintext highlighter-rouge">http://fake002.berkeley.edu/image.jpg</code>, etc. To fetch these images, the browser will first make a DNS request for the domains <code class="language-plaintext highlighter-rouge">fake001.berkeley.edu</code>, <code class="language-plaintext highlighter-rouge">fake002.berkeley.edu</code>, etc. For each request, if the legitimate response arrives before the malicious response, or if the off-path attacker incorrectly guesses the ID field, nothing is cached, so the attacker can immediately try again when the victim makes the next DNS request to the next non-existent domain.</p> <p>The Kaminsky attack allows on-path attackers to race until their fake response arrives first and off-path attackers to race until they successfully guess the ID field. There is no way to completely eliminate the Kaminsky attack in regular DNS, although modern DNS protocols add <strong>UDP source port randomization</strong> to make it much harder.</p> <p>Recall that UDP is a transport-layer protocol like TCP, so a UDP packet requires a source port and destination port. The destination port must be well-known and constant (in practice, it is always 53), so everyone can send UDP packets to the correct port on the name server. However, DNS doesn’t specify what source port the resolver uses to send queries, so source port randomization uses a random 16-bit source port for each query. The name server must send the response packet back to the correct source port of the resolver, so it must include the source port number in the destination port field of the response. Now, an attacker must guess the 16-bit ID field and the 16-bit source port in order to successfully forge a response packet. This decreases an off-path attacker’s probability of success to \(1/2^{32}\), which is much harder, but certainly not impossible.</p> <p><img src="/assets/images/network/dns/source-port-randomization.png" alt="Diagram of source port randomization in use. The query's source port is randomized, and the destination port is 53. The response's source port is 53, and the destination port is the same randomized value" /></p> <p>Sanity check: How much extra security does source port randomization provide against on-path attackers?<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup></p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1" role="doc-endnote"> <p>A: MITM and on-path can read the ID field. Off-path must guess the ID field. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:2" role="doc-endnote"> <p>Query <code class="language-plaintext highlighter-rouge">a.edu-servers.net</code>, whose location we know because of the records in the additional section. Query for the IP address of <code class="language-plaintext highlighter-rouge">eecs.berkeley.edu</code> just like before. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:3" role="doc-endnote"> <p>A: None, on-path attackers can see the source port value. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
